"use client"

import { useState, useEffect, useCallback } from "react"
import { DashboardLayout } from "@/components/dashboard/dashboard-layout"
import { ConfigForm } from "@/components/vulnerability/config-form"
import { ImpactPreview } from "@/components/vulnerability/impact-preview"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { Settings, History, Eye, EyeOff, Loader2 } from "lucide-react"
import apiClient from "@/lib/api-client"
import { useApiQuery } from "@/hooks/use-api-query"
import type { VulnerabilityWeights, VulnerabilityBand, VulnerabilityImpact, VulnerabilityConfig } from "@/types/vulnerability"

const DEFAULT_WEIGHTS: VulnerabilityWeights = {
  health: 25,
  isolation: 20,
  domesticHelp: 15,
  hoursAlone: 15,
  onlineDependency: 10,
  overdueVisit: 15,
}

export default function VulnerabilityPage() {
  const [config, setConfig] = useState<VulnerabilityConfig | null>(null)
  const [history, setHistory] = useState<VulnerabilityConfig[]>([])
  const [weights, setWeights] = useState<VulnerabilityWeights>(DEFAULT_WEIGHTS)
  const [bands, setBands] = useState<VulnerabilityBand[]>([])
  const [impact, setImpact] = useState<VulnerabilityImpact | null>(null)
  const [showPreview, setShowPreview] = useState(false)
  const [hasChanges, setHasChanges] = useState(false)
  // const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [previewLoading, setPreviewLoading] = useState(false)
  const [error, setError] = useState<string>("")
  const [historyOpen, setHistoryOpen] = useState(false)

  const fetchConfig = useCallback(() => apiClient.getVulnerabilityConfig(), [])
  const fetchHistory = useCallback(() => apiClient.getVulnerabilityConfigHistory(), [])

  const { data: configData, loading: configLoading, refetch: refetchConfig } = useApiQuery<{ data: { config: VulnerabilityConfig } }>(fetchConfig, { refetchOnMount: true })
  const { data: historyData, loading: historyLoading, refetch: refetchHistory } = useApiQuery<{ data: { history: VulnerabilityConfig[] } }>(fetchHistory, { refetchOnMount: true })

  const loading = configLoading || historyLoading

  useEffect(() => {
    if (configData?.data?.config) {
      const currentConfig = configData.data.config
      setConfig(currentConfig)
      setWeights(currentConfig.weights)
      setBands(currentConfig.bands)
    }
  }, [configData])

  useEffect(() => {
    if (historyData?.data?.history) {
      setHistory(historyData.data.history)
    }
  }, [historyData])

  useEffect(() => {
    if (!config) return
    const weightsChanged = JSON.stringify(weights) !== JSON.stringify(config.weights)
    const bandsChanged = JSON.stringify(bands) !== JSON.stringify(config.bands)
    setHasChanges(weightsChanged || bandsChanged)
  }, [weights, bands, config])

  const handleSave = async () => {
    if (!hasChanges) return
    try {
      setSaving(true)
      const response = await apiClient.updateVulnerabilityConfig({ weights, bands })
      setConfig(response.data.config)
      setHistory(response.data.history)
      setImpact(response.data.impact)
      setHasChanges(false)
      setShowPreview(true)
      setError("")
    } catch (err: any) {
      setError(err?.response?.data?.message || "Failed to update vulnerability configuration.")
    } finally {
      setSaving(false)
    }
  }

  const handleReset = () => {
    if (!config) return
    setWeights(config.weights)
    setBands(config.bands)
    setHasChanges(false)
    setShowPreview(false)
    setImpact(null)
  }

  const handlePreview = async () => {
    if (!hasChanges) {
      setShowPreview(false)
      setImpact(null)
      return
    }
    try {
      setPreviewLoading(true)
      const response = await apiClient.previewVulnerabilityImpact({ weights, bands })
      setImpact(response.data.impact)
      setShowPreview(true)
      setError("")
    } catch (err: any) {
      setError(err?.response?.data?.message || "Unable to calculate impact preview.")
    } finally {
      setPreviewLoading(false)
    }
  }

  const formatDateTime = (dateString?: string) => {
    if (!dateString) return "Never"
    return new Date(dateString).toLocaleString()
  }

  if (loading || !config) {
    return (
      <DashboardLayout title="Vulnerability Assessment" description="Assess and manage citizen vulnerability levels">
        <div className="flex min-h-[60vh] items-center justify-center">
          <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
        </div>
      </DashboardLayout>
    )
  }

  return (
    <DashboardLayout title="Vulnerability Assessment" description="Assess and manage citizen vulnerability levels">
      <div className="space-y-6">
        {error && (
          <Alert variant="destructive">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold">Vulnerability Configuration</h1>
            <p className="text-muted-foreground">Configure risk assessment weights and bands for senior citizens</p>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" size="sm" onClick={() => setHistoryOpen(!historyOpen)}>
              <History className="h-4 w-4 mr-2" />
              {historyOpen ? "Hide History" : "Version History"}
            </Button>
            <Button size="sm" onClick={handleSave} disabled={!hasChanges || saving}>
              {saving ? <Loader2 className="h-4 w-4 mr-2 animate-spin" /> : null}
              Publish Changes
            </Button>
          </div>
        </div>

        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Settings className="h-5 w-5" />
              Current Configuration
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p className="text-sm font-medium">Version</p>
                <Badge variant="secondary">v{config.version}</Badge>
              </div>
              <div>
                <p className="text-sm font-medium">Status</p>
                <Badge variant={config.isActive ? "default" : "secondary"}>
                  {config.isActive ? "Active" : "Inactive"}
                </Badge>
              </div>
              <div>
                <p className="text-sm font-medium">Last Published</p>
                <p className="text-xs text-muted-foreground">{formatDateTime(config.publishedAt)}</p>
              </div>
              <div>
                <p className="text-sm font-medium">Published By</p>
                <p className="text-xs text-muted-foreground">{config.publishedByName || "N/A"}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        {historyOpen && (
          <Card>
            <CardHeader>
              <CardTitle>Version History</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {history.map((entry) => (
                <div key={entry.id} className="flex flex-wrap items-center justify-between border-b pb-2 last:border-b-0 last:pb-0">
                  <div>
                    <p className="font-medium">Version {entry.version}</p>
                    <p className="text-xs text-muted-foreground">
                      {entry.publishedByName || "System"} Â· {formatDateTime(entry.publishedAt)}
                    </p>
                  </div>
                  <Badge variant={entry.isActive ? "default" : "outline"}>
                    {entry.isActive ? "Active" : "Archived"}
                  </Badge>
                </div>
              ))}
            </CardContent>
          </Card>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <ConfigForm
              weights={weights}
              bands={bands}
              onWeightsChange={setWeights}
              onBandsChange={setBands}
              onSave={handleSave}
              onReset={handleReset}
              onPreview={handlePreview}
              hasChanges={hasChanges}
            />
          </div>

          <div className="lg:col-span-1">
            <div className="sticky top-6">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center justify-between">
                    Impact Preview
                    <Button variant="ghost" size="sm" onClick={handlePreview} disabled={previewLoading}>
                      {previewLoading ? (
                        <Loader2 className="h-4 w-4 animate-spin" />
                      ) : showPreview ? (
                        <EyeOff className="h-4 w-4" />
                      ) : (
                        <Eye className="h-4 w-4" />
                      )}
                    </Button>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  {showPreview && impact ? (
                    <ImpactPreview impact={impact} />
                  ) : (
                    <div className="text-center text-muted-foreground py-8">
                      <Eye className="h-12 w-12 mx-auto mb-4 opacity-50" />
                      <p className="text-sm">
                        {hasChanges ? "Click 'Preview Impact' to see projected changes" : "Make changes to see impact preview"}
                      </p>
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          </div>
        </div>
      </div>
    </DashboardLayout>
  )
}
