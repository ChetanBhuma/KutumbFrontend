"use client"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Slider } from "@/components/ui/slider"
import { Input } from "@/components/ui/input"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import { Save, RotateCcw, Eye } from "lucide-react"
import type { VulnerabilityWeights, VulnerabilityBand } from "@/types/vulnerability"

interface ConfigFormProps {
  weights: VulnerabilityWeights
  bands: VulnerabilityBand[]
  onWeightsChange: (weights: VulnerabilityWeights) => void
  onBandsChange: (bands: VulnerabilityBand[]) => void
  onSave: () => void
  onReset: () => void
  onPreview: () => void
  hasChanges: boolean
}

export function ConfigForm({
  weights,
  bands,
  onWeightsChange,
  onBandsChange,
  onSave,
  onReset,
  onPreview,
  hasChanges,
}: ConfigFormProps) {
  const handleWeightChange = (key: keyof VulnerabilityWeights, value: number[]) => {
    onWeightsChange({
      ...weights,
      [key]: value[0],
    })
  }

  const handleBandChange = (bandId: string, field: keyof VulnerabilityBand, value: any) => {
    onBandsChange(
      bands.map((band) =>
        band.id === bandId
          ? {
              ...band,
              [field]: value,
            }
          : band,
      ),
    )
  }

  const totalWeight = Object.values(weights).reduce((sum, weight) => sum + weight, 0)
  const isValidWeight = totalWeight === 100

  const weightFactors = [
    { key: "health" as const, label: "Health Conditions", description: "Medical issues, chronic conditions" },
    { key: "isolation" as const, label: "Social Isolation", description: "Lack of family/social support" },
    { key: "domesticHelp" as const, label: "Domestic Help", description: "Need for daily assistance" },
    { key: "hoursAlone" as const, label: "Hours Alone", description: "Time spent without supervision" },
    { key: "onlineDependency" as const, label: "Online Dependency", description: "Reliance on digital services" },
    { key: "overdueVisit" as const, label: "Overdue Visits", description: "Missed or delayed welfare checks" },
  ]

  return (
    <div className="space-y-6">
      {/* Weights Configuration */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center justify-between">
            Vulnerability Weights
            <Badge variant={isValidWeight ? "secondary" : "destructive"}>
              Total: {totalWeight}% {!isValidWeight && "(Must equal 100%)"}
            </Badge>
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {weightFactors.map((factor) => (
            <div key={factor.key} className="space-y-2">
              <div className="flex items-center justify-between">
                <div>
                  <Label className="font-medium">{factor.label}</Label>
                  <p className="text-xs text-muted-foreground">{factor.description}</p>
                </div>
                <Badge variant="outline">{weights[factor.key]}%</Badge>
              </div>
              <Slider
                value={[weights[factor.key]]}
                onValueChange={(value) => handleWeightChange(factor.key, value)}
                max={50}
                min={0}
                step={1}
                className="w-full"
              />
            </div>
          ))}
        </CardContent>
      </Card>

      {/* Bands Configuration */}
      <Card>
        <CardHeader>
          <CardTitle>Risk Bands Configuration</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {bands.map((band, index) => (
            <div key={band.id}>
              <div className="flex items-center gap-4 mb-4">
                <div className="w-4 h-4 rounded-full" style={{ backgroundColor: band.color }} />
                <h4 className="font-medium">{band.label}</h4>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div>
                  <Label htmlFor={`${band.id}-min`}>Min Score</Label>
                  <Input
                    id={`${band.id}-min`}
                    type="number"
                    value={band.min}
                    onChange={(e) => handleBandChange(band.id, "min", Number.parseInt(e.target.value))}
                    min={0}
                    max={100}
                  />
                </div>

                <div>
                  <Label htmlFor={`${band.id}-max`}>Max Score</Label>
                  <Input
                    id={`${band.id}-max`}
                    type="number"
                    value={band.max}
                    onChange={(e) => handleBandChange(band.id, "max", Number.parseInt(e.target.value))}
                    min={0}
                    max={100}
                  />
                </div>

                <div>
                  <Label htmlFor={`${band.id}-frequency`}>Visit Frequency (Days)</Label>
                  <Input
                    id={`${band.id}-frequency`}
                    type="number"
                    value={band.visitFrequencyDays}
                    onChange={(e) => handleBandChange(band.id, "visitFrequencyDays", Number.parseInt(e.target.value))}
                    min={1}
                    max={90}
                  />
                </div>
              </div>

              {index < bands.length - 1 && <Separator className="mt-6" />}
            </div>
          ))}
        </CardContent>
      </Card>

      {/* Actions */}
      <div className="flex items-center justify-between">
        <div className="flex gap-2">
          <Button variant="outline" onClick={onReset} disabled={!hasChanges}>
            <RotateCcw className="h-4 w-4 mr-2" />
            Reset Changes
          </Button>
          <Button variant="outline" onClick={onPreview}>
            <Eye className="h-4 w-4 mr-2" />
            Preview Impact
          </Button>
        </div>

        <Button onClick={onSave} disabled={!hasChanges || !isValidWeight}>
          <Save className="h-4 w-4 mr-2" />
          Save Configuration
        </Button>
      </div>
    </div>
  )
}
