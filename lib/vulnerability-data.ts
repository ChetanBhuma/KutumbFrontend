import type {
  VulnerabilityConfig,
  VulnerabilityBand,
  VulnerabilityWeights,
  VulnerabilityImpact,
  CitizenVulnerabilityProfile,
} from "@/types/vulnerability"

// Default vulnerability bands
export const defaultBands: VulnerabilityBand[] = [
  {
    id: "band-low",
    name: "low",
    label: "Low Risk",
    min: 0,
    max: 40,
    color: "#22c55e", // green-500
    visitFrequencyDays: 30,
  },
  {
    id: "band-medium",
    name: "medium",
    label: "Medium Risk",
    min: 41,
    max: 70,
    color: "#eab308", // yellow-500
    visitFrequencyDays: 14,
  },
  {
    id: "band-high",
    name: "high",
    label: "High Risk",
    min: 71,
    max: 100,
    color: "#ef4444", // red-500
    visitFrequencyDays: 7,
  },
]

// Default vulnerability weights
export const defaultWeights: VulnerabilityWeights = {
  health: 25,
  isolation: 20,
  domesticHelp: 15,
  hoursAlone: 15,
  onlineDependency: 10,
  overdueVisit: 15,
}

// Mock current configuration
export const mockVulnerabilityConfig: VulnerabilityConfig = {
  id: "config-001",
  version: 1,
  weights: defaultWeights,
  bands: defaultBands,
  isActive: true,
  createdBy: "admin-001",
  createdByName: "System Administrator",
  createdAt: "2024-01-01T00:00:00Z",
  publishedAt: "2024-01-01T00:00:00Z",
  publishedBy: "admin-001",
  publishedByName: "System Administrator",
}

// Mock citizen vulnerability profiles
export const mockCitizenProfiles: CitizenVulnerabilityProfile[] = [
  {
    citizenId: "citizen-001",
    citizenName: "Shri Ram Kumar Sharma",
    currentScore: 85,
    projectedScore: 85,
    currentBand: "high",
    projectedBand: "high",
    factors: {
      health: 20, // out of 25
      isolation: 18, // out of 20
      domesticHelp: 12, // out of 15
      hoursAlone: 13, // out of 15
      onlineDependency: 8, // out of 10
      overdueVisit: 14, // out of 15
    },
    lastCalculatedAt: "2024-01-15T10:30:00Z",
  },
  {
    citizenId: "citizen-002",
    citizenName: "Smt. Kamala Devi",
    currentScore: 72,
    projectedScore: 72,
    currentBand: "high",
    projectedBand: "high",
    factors: {
      health: 18,
      isolation: 15,
      domesticHelp: 10,
      hoursAlone: 12,
      onlineDependency: 7,
      overdueVisit: 10,
    },
    lastCalculatedAt: "2024-01-15T10:30:00Z",
  },
  {
    citizenId: "citizen-003",
    citizenName: "Shri Mohan Lal Gupta",
    currentScore: 91,
    projectedScore: 91,
    currentBand: "high",
    projectedBand: "high",
    factors: {
      health: 23,
      isolation: 19,
      domesticHelp: 14,
      hoursAlone: 14,
      onlineDependency: 9,
      overdueVisit: 12,
    },
    lastCalculatedAt: "2024-01-15T10:30:00Z",
  },
  {
    citizenId: "citizen-004",
    citizenName: "Smt. Sunita Agarwal",
    currentScore: 68,
    projectedScore: 68,
    currentBand: "medium",
    projectedBand: "medium",
    factors: {
      health: 15,
      isolation: 12,
      domesticHelp: 8,
      hoursAlone: 10,
      onlineDependency: 6,
      overdueVisit: 17, // High due to overdue
    },
    lastCalculatedAt: "2024-01-15T10:30:00Z",
  },
  {
    citizenId: "citizen-005",
    citizenName: "Shri Rajesh Kumar",
    currentScore: 45,
    projectedScore: 45,
    currentBand: "medium",
    projectedBand: "medium",
    factors: {
      health: 10,
      isolation: 8,
      domesticHelp: 5,
      hoursAlone: 7,
      onlineDependency: 4,
      overdueVisit: 11,
    },
    lastCalculatedAt: "2024-01-15T10:30:00Z",
  },
]

// Calculate vulnerability score
export function calculateVulnerabilityScore(
  factors: CitizenVulnerabilityProfile["factors"],
  weights: VulnerabilityWeights,
): number {
  const score =
    (factors.health / 25) * weights.health +
    (factors.isolation / 20) * weights.isolation +
    (factors.domesticHelp / 15) * weights.domesticHelp +
    (factors.hoursAlone / 15) * weights.hoursAlone +
    (factors.onlineDependency / 10) * weights.onlineDependency +
    (factors.overdueVisit / 15) * weights.overdueVisit

  return Math.round(score)
}

// Get band for score
export function getBandForScore(score: number, bands: VulnerabilityBand[]): VulnerabilityBand {
  return bands.find((band) => score >= band.min && score <= band.max) || bands[0]
}

// Calculate impact of configuration changes
export function calculateImpact(
  currentConfig: VulnerabilityConfig,
  newWeights: VulnerabilityWeights,
  newBands: VulnerabilityBand[],
  citizenProfiles: CitizenVulnerabilityProfile[],
): VulnerabilityImpact {
  // Calculate current distribution
  const currentDistribution = { low: 0, medium: 0, high: 0 }
  const projectedDistribution = { low: 0, medium: 0, high: 0 }

  citizenProfiles.forEach((profile) => {
    // Current band
    const currentBand = getBandForScore(profile.currentScore, currentConfig.bands)
    currentDistribution[currentBand.name]++

    // Projected score with new weights
    const projectedScore = calculateVulnerabilityScore(profile.factors, newWeights)
    const projectedBand = getBandForScore(projectedScore, newBands)
    projectedDistribution[projectedBand.name]++
  })

  // Calculate changes
  const changes = {
    low: projectedDistribution.low - currentDistribution.low,
    medium: projectedDistribution.medium - currentDistribution.medium,
    high: projectedDistribution.high - currentDistribution.high,
  }

  // Calculate visit frequency impact
  const dailyVisits = Math.round(
    (projectedDistribution.high / newBands.find((b) => b.name === "high")!.visitFrequencyDays +
      projectedDistribution.medium / newBands.find((b) => b.name === "medium")!.visitFrequencyDays +
      projectedDistribution.low / newBands.find((b) => b.name === "low")!.visitFrequencyDays) *
      7,
  )

  return {
    totalCitizens: citizenProfiles.length,
    currentDistribution,
    projectedDistribution,
    changes,
    visitFrequencyImpact: {
      dailyVisits: Math.round(dailyVisits / 7),
      weeklyVisits: dailyVisits,
      monthlyVisits: dailyVisits * 4,
    },
  }
}
